<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω–∫–∞ –û–°–¢–†–û–í ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèùÔ∏è</text></svg>">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 24px; background: #1a1d23; color: #e4e6eb; min-height: 100vh; }
        .admin { max-width: 900px; margin: 0 auto; }
        h1 { color: #58a6ff; margin-bottom: 8px; font-weight: 600; }
        .subtitle { color: #8b949e; margin-bottom: 24px; font-size: 14px; }
        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn-primary { background: #238636; color: white; }
        .btn-primary:hover { background: #2ea043; }
        .btn-secondary { background: #30363d; color: #e4e6eb; border: 1px solid #484f58; }
        .btn-secondary:hover { background: #393f47; }
        .btn-danger { background: #da3633; color: white; }
        .btn-danger:hover { background: #f85149; }
        table { width: 100%; border-collapse: collapse; background: #21262d; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #30363d; }
        th { background: #161b22; color: #8b949e; font-weight: 600; font-size: 12px; text-transform: uppercase; }
        tr:hover { background: #262b33; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 100; }
        .modal.active { display: flex; }
        .modal-box { background: #21262d; border-radius: 8px; padding: 24px; width: 100%; max-width: 420px; border: 1px solid #30363d; }
        .modal-box h2 { margin-top: 0; margin-bottom: 20px; color: #58a6ff; font-size: 18px; }
        label { display: block; margin-bottom: 6px; color: #8b949e; font-size: 13px; }
        input { width: 100%; padding: 10px 12px; border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: #e4e6eb; margin-bottom: 14px; font-size: 14px; }
        input:focus { outline: none; border-color: #58a6ff; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .error { color: #f85149; font-size: 13px; margin-top: 8px; }
        .hidden { display: none; }
        .empty { color: #8b949e; text-align: center; padding: 40px; }
        a { color: #58a6ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="admin">
        <h1>üèùÔ∏è –ê–¥–º–∏–Ω–∫–∞ –û–°–¢–†–û–í</h1>
        <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</p>

        <div class="toolbar">
            <button class="btn-primary" onclick="openCreateModal()">+ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
            <button class="btn-secondary" onclick="loadUsers()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <a href="/index.html"><button class="btn-secondary">‚Üê –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button></a>
        </div>

        <div id="users-table">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–§–ò–û</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ì–æ—Ä–æ–¥</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="users-body">
                    <tr><td colspan="5" class="empty">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="modal-error" class="error hidden"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="modal" class="modal">
        <div class="modal-box">
            <h2 id="modal-title">–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
            <form id="user-form" onsubmit="submitUser(event)">
                <input type="hidden" id="user-id" value="">
                <label>–§–ò–û</label>
                <input type="text" id="full_name" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="phone" required placeholder="89998884433">
                <label>–ì–æ—Ä–æ–¥</label>
                <input type="text" id="city" placeholder="–ú–æ—Å–∫–≤–∞">
                <label id="password-label">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" id="password-input">
                <p class="error" id="form-error"></p>
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-primary" id="submit-btn">–°–æ–∑–¥–∞—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://23.172.217.180:8000';

        async function loadUsers() {
            const tbody = document.getElementById('users-body');
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users`);
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                const users = await res.json();
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>';
                    return;
                }
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${escapeHtml(u.full_name || '‚Äî')}</td>
                        <td>${escapeHtml(u.phone || '‚Äî')}</td>
                        <td>${escapeHtml(u.city || '‚Äî')}</td>
                        <td>
                            <button class="btn-secondary" onclick="editUser(${u.id})">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                            <button class="btn-danger" onclick="deleteUser(${u.id}, '${escapeHtml(String(u.full_name || ''))}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty">–û—à–∏–±–∫–∞: ' + escapeHtml(e.message) + '</td></tr>';
            }
        }

        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function openCreateModal() {
            document.getElementById('modal-title').textContent = '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('submit-btn').textContent = '–°–æ–∑–¥–∞—Ç—å';
            document.getElementById('user-id').value = '';
            document.getElementById('full_name').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('city').value = '';
            document.getElementById('password').value = '';
            document.getElementById('password').required = true;
            document.getElementById('password-label').textContent = '–ü–∞—Ä–æ–ª—å';
            document.getElementById('form-error').textContent = '';
            document.getElementById('modal').classList.add('active');
        }

        async function editUser(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${id}`);
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                const u = await res.json();
                document.getElementById('modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                document.getElementById('submit-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                document.getElementById('user-id').value = u.id;
                document.getElementById('full_name').value = u.full_name || '';
                document.getElementById('phone').value = u.phone || '';
                document.getElementById('city').value = u.city || '';
                document.getElementById('password').value = '';
                document.getElementById('password').required = false;
                document.getElementById('password-label').textContent = '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å)';
                document.getElementById('form-error').textContent = '';
                document.getElementById('modal').classList.add('active');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        async function submitUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const data = {
                full_name: document.getElementById('full_name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                city: document.getElementById('city').value.trim()
            };
            const password = document.getElementById('password').value;
            if (password) data.password = password;

            const errEl = document.getElementById('form-error');
            errEl.textContent = '';

            try {
                let res;
                if (id) {
                    res = await fetch(`${API_BASE_URL}/admin/users/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    if (!password) {
                        errEl.textContent = '–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                        return;
                    }
                    data.password = password;
                    res = await fetch(`${API_BASE_URL}/admin/users`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                const errData = await res.json().catch(() => ({}));
                if (!res.ok) {
                    errEl.textContent = errData.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
                    return;
                }
                closeModal();
                loadUsers();
            } catch (e) {
                errEl.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + e.message;
            }
        }

        async function deleteUser(id, name) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ¬´' + name + '¬ª?')) return;
            try {
                const res = await fetch(`${API_BASE_URL}/admin/users/${id}`, { method: 'DELETE' });
                if (!res.ok) {
                    const d = await res.json();
                    alert(d.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    return;
                }
                loadUsers();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        loadUsers();
    </script>
</body>
</html>
